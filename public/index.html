<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>链式笔记</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --sidebar-width: 300px;
            --navbar-height: 56px;
        }

        body {
            background-color: #f8f9fa;
            overflow-x: hidden;
        }

        .navbar {
            z-index: 1030;
            height: var(--navbar-height); /* 明确设置导航栏高度 */
        }
        
        #sidebar {
            position: fixed;
            top: calc(var(--navbar-height) + 16px);
            bottom: 16px;
            left: 16px;
            width: var(--sidebar-width);
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 0.75rem;
            box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,.1);
            transition: transform 0.3s ease-in-out;
            z-index: 1020;
            display: flex;
            flex-direction: column;
        }
        
        body.sidebar-collapsed #sidebar {
            transform: translateX(calc(-100% - 32px));
        }

        #note-list-container {
            flex-grow: 1;
            overflow-y: auto;
        }

        #note-list .list-group-item {
            cursor: pointer;
            border-radius: 0.5rem !important;
            margin-bottom: 4px;
            border: none;
        }

        #main-content {
            padding-top: var(--navbar-height); /* 调整为导航栏高度 */
            height: 100vh;
            margin-left: calc(var(--sidebar-width) + 32px);
            transition: margin-left 0.3s ease-in-out;
            display: flex; /* 使用flex布局 */
            flex-direction: column;
        }
        
        body.sidebar-collapsed #main-content {
            margin-left: 64px;
        }

        /* 内容容器，添加内边距并允许滚动 */
        #content-container {
            flex-grow: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .sidebar-toggler {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1021;
            width: 28px;
            height: 48px;
            border: 1px solid #dee2e6;
            background-color: #fff;
            color: #6c757d;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .sidebar-toggler:hover {
            background-color: #e9ecef;
            color: #000;
        }

        #hide-sidebar-btn {
            left: calc(var(--sidebar-width) + 16px);
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
            border-left: none;
        }
        body.sidebar-collapsed #hide-sidebar-btn {
            opacity: 0;
            pointer-events: none;
        }

        #show-sidebar-btn {
            left: 0;
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
            border-left: none;
            opacity: 0;
            pointer-events: none;
        }
        body.sidebar-collapsed #show-sidebar-btn {
            opacity: 1;
            pointer-events: auto;
        }
        
        .note-link { color: var(--bs-primary); text-decoration: underline; cursor: pointer; font-weight: 600; }
        .note-link-broken { color: var(--bs-danger); text-decoration: line-through; cursor: not-allowed; }
        
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 250px;
            }
            #sidebar {
                box-shadow: 0 0.5rem 3rem rgba(0,0,0,.25);
            }
            #main-content {
                margin-left: 16px !important;
                margin-right: 16px !important;
            }
            .sidebar-toggler {
                top: 50%;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">我的笔记</a>
            <div class="d-flex ms-auto align-items-center">
                <button id="new-note-btn" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-lg me-1"></i>新建笔记
                </button>
            </div>
        </div>
    </nav>

    <aside id="sidebar">
        <div class="p-3 border-bottom">
            <div class="input-group input-group-sm mb-2">
                <input id="search-input" class="form-control" type="search" placeholder="搜索笔记..." aria-label="Search">
            </div>
        </div>
        <div id="note-list-container" class="p-2">
            <ul id="note-list" class="list-group list-group-flush">
                <!-- 笔记列表将通过JS动态生成 -->
            </ul>
        </div>
    </aside>

    <button id="hide-sidebar-btn" class="sidebar-toggler" title="收起侧边栏">&laquo;</button>
    <button id="show-sidebar-btn" class="sidebar-toggler" title="展开侧边栏">&raquo;</button>
    
    <main id="main-content">
        <!-- 新增内容容器 -->
        <div id="content-container">
            <div id="welcome-view" class="d-flex flex-column align-items-center justify-content-center h-100 text-center">
                <i class="bi bi-journal-richtext" style="font-size: 4rem; color: #ced4da;"></i>
                <h2 class="mt-3 text-muted">欢迎使用链式笔记</h2>
                <p class="text-secondary">从左侧选择一篇笔记开始编辑，或新建一篇笔记。</p>
            </div>

            <div id="editor-view" class="d-none h-100 flex-column">
                <div class="mb-3">
                    <input type="text" id="note-title-input" class="form-control form-control-lg border-0 fs-2 fw-bold p-1" placeholder="笔记标题...">
                </div>

                <div class="row flex-grow-1" style="min-height: 0;">
                    <div class="col-12 h-100 d-flex flex-column">
                        <label for="note-content-textarea" class="form-label small fw-semibold text-muted">编辑内容 (使用 `[[ID]]` 或 `[[标题]]` 来链接)</label>
                        <textarea id="note-content-textarea" class="form-control flex-grow-1" placeholder="在这里写下你的想法..."></textarea>
                        
                        <div class="d-flex justify-content-between mt-3">
                            <div>
                                <button id="save-note-btn" class="btn btn-success me-2" disabled>
                                    <i class="bi bi-check-lg me-1"></i>保存
                                </button>
                                <button id="delete-note-btn" class="btn btn-danger me-2">
                                    <i class="bi bi-trash me-1"></i>删除
                                </button>
                            </div>
                            <button id="toggle-preview-btn" class="btn btn-outline-secondary">
                                <i class="bi bi-eye me-1"></i>预览
                            </button>
                        </div>
                    </div>
                    
                    <div id="preview-container" class="col-12 d-none flex-column mt-3">
                        <h3 class="form-label small fw-semibold text-muted mb-3">实时预览</h3>
                        <div id="note-preview" class="w-100 flex-grow-1 p-3 bg-white border rounded overflow-y-auto">
                            <!-- 预览内容将通过JS动态生成 -->
                        </div>
                    </div>
                </div>

                <div class="text-muted small mt-3">
                    当前笔记ID: <span id="current-note-id" class="font-monospace"></span>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const body = document.body;
            const sidebar = document.getElementById('sidebar');
            const hideSidebarBtn = document.getElementById('hide-sidebar-btn');
            const showSidebarBtn = document.getElementById('show-sidebar-btn');
            const noteList = document.getElementById('note-list');
            const searchInput = document.getElementById('search-input');
            const newNoteBtn = document.getElementById('new-note-btn');
            const saveNoteBtn = document.getElementById('save-note-btn');
            const deleteNoteBtn = document.getElementById('delete-note-btn');
            const noteTitleInput = document.getElementById('note-title-input');
            const noteContentTextarea = document.getElementById('note-content-textarea');
            const notePreview = document.getElementById('note-preview');
            const welcomeView = document.getElementById('welcome-view');
            const editorView = document.getElementById('editor-view');
            const currentNoteIdSpan = document.getElementById('current-note-id');

            let notes = [];
            let currentNoteId = null;

            function loadNotes() {
                const notesData = localStorage.getItem('chain-notes-data-bs');
                notes = notesData ? JSON.parse(notesData) : [{ id: 1, title: '欢迎使用', content: '这是链式笔记系统！\n\n- 点击侧边栏右侧的 « 按钮可以收起它。\n- 点击屏幕左侧的 » 按钮可以把它叫出来。\n- 链接语法是 [[ID]] 或 [[标题]]。'}];
            }

            function saveNotes() {
                localStorage.setItem('chain-notes-data-bs', JSON.stringify(notes));
            }
            
            function toggleSidebar() {
                const isCollapsed = body.classList.toggle('sidebar-collapsed');
                localStorage.setItem('sidebar-collapsed', isCollapsed);
            }

            function initSidebarState() {
                const savedState = localStorage.getItem('sidebar-collapsed');
                const isMobile = window.matchMedia('(max-width: 768px)').matches;
                if (savedState === null && isMobile) {
                    body.classList.add('sidebar-collapsed');
                    localStorage.setItem('sidebar-collapsed', 'true');
                } else if (savedState === 'true') {
                    body.classList.add('sidebar-collapsed');
                }
            }

            function renderNoteList(filter = '') {
                noteList.innerHTML = '';
                const sortedNotes = [...notes].sort((a, b) => a.id - b.id);
                const filteredNotes = filter ? sortedNotes.filter(n => 
                    n.title.toLowerCase().includes(filter.toLowerCase()) || 
                    n.content.toLowerCase().includes(filter.toLowerCase())
                ) : sortedNotes;
                
                if (filteredNotes.length === 0) {
                    noteList.innerHTML = '<li class="list-group-item text-center text-muted">没有匹配的笔记</li>';
                    return;
                }
                
                filteredNotes.forEach(note => {
                    const li = document.createElement('li');
                    li.dataset.id = note.id;
                    li.className = `list-group-item list-group-item-action border-0 ${note.id === currentNoteId ? 'active' : ''}`;
                    li.textContent = `[${note.id}] ${note.title}`;
                    li.addEventListener('click', () => displayNote(note.id));
                    noteList.appendChild(li);
                });
            }
            
            function renderPreview(content) {
                const linkRegex = /\[\[(.*?)\]\]/g;
                const htmlContent = content.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>').replace(linkRegex, (match, linkTarget) => {
                    linkTarget = linkTarget.trim();
                    const targetNote = notes.find(n => String(n.id) === linkTarget || n.title.toLowerCase() === linkTarget.toLowerCase());
                    return targetNote ? 
                        `<a class="note-link" data-link-id="${targetNote.id}">${match}</a>` : 
                        `<span class="note-link-broken">${match}</span>`;
                });
                notePreview.innerHTML = htmlContent;
            }

            function displayNote(id) {
                const note = notes.find(n => n.id === id);
                if (!note) return;
                
                currentNoteId = id;
                welcomeView.classList.replace('d-flex', 'd-none');
                editorView.classList.replace('d-none', 'd-flex');
                noteTitleInput.value = note.title;
                noteContentTextarea.value = note.content;
                currentNoteIdSpan.textContent = note.id;
                renderPreview(note.content);
                renderNoteList(searchInput.value);
                saveNoteBtn.disabled = true;
            }

            hideSidebarBtn.addEventListener('click', toggleSidebar);
            showSidebarBtn.addEventListener('click', toggleSidebar);
            searchInput.addEventListener('input', () => renderNoteList(searchInput.value));

            newNoteBtn.addEventListener('click', () => {
                const newId = notes.length > 0 ? Math.max(...notes.map(n => n.id)) + 1 : 1;
                const newNote = { id: newId, title: '未命名笔记', content: '' };
                notes.push(newNote);
                saveNotes();
                displayNote(newId);
                renderNoteList();
                noteTitleInput.focus();
            });

            saveNoteBtn.addEventListener('click', () => {
                if (!currentNoteId) return;
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    note.title = noteTitleInput.value.trim() || '未命名笔记';
                    note.content = noteContentTextarea.value;
                    saveNotes();
                    renderNoteList(searchInput.value);
                    renderPreview(note.content);
                    saveNoteBtn.disabled = true;
                    saveNoteBtn.innerHTML = '<i class="bi bi-check-all me-1"></i>已保存!';
                    setTimeout(() => { saveNoteBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i>保存'; }, 1500);
                }
            });

            deleteNoteBtn.addEventListener('click', () => {
                if (!currentNoteId || window.prompt(`确定要删除这篇笔记吗？\n笔记ID: ${currentNoteId}\n标题: ${noteTitleInput.value}\n\n请输入 "删除" 来确认。`) !== '删除') return;
                
                notes = notes.filter(n => n.id !== currentNoteId);
                saveNotes();
                currentNoteId = null;
                editorView.classList.replace('d-flex', 'd-none');
                welcomeView.classList.replace('d-none', 'd-flex');
                renderNoteList();
            });
            
            noteTitleInput.addEventListener('input', () => { saveNoteBtn.disabled = false; });
            noteContentTextarea.addEventListener('input', () => {
                saveNoteBtn.disabled = false;
                renderPreview(noteContentTextarea.value);
            });

            notePreview.addEventListener('click', (e) => {
                if (e.target.classList.contains('note-link')) {
                    const linkId = parseInt(e.target.dataset.linkId, 10);
                    if (linkId) displayNote(linkId);
                }
            });

            function init() {
                loadNotes();
                initSidebarState();
                renderNoteList();
            }
            init();
        });
    </script>

    <script>
        // 添加预览切换功能
        const togglePreviewBtn = document.getElementById('toggle-preview-btn');
        const previewContainer = document.getElementById('preview-container');
        let isPreviewVisible = false;
        
        togglePreviewBtn.addEventListener('click', () => {
            isPreviewVisible = !isPreviewVisible;
            previewContainer.classList.toggle('d-none', !isPreviewVisible);
            togglePreviewBtn.innerHTML = isPreviewVisible 
                ? '<i class="bi bi-eye-slash me-1"></i>隐藏预览' 
                : '<i class="bi bi-eye me-1"></i>预览';
            
            if (isPreviewVisible) {
                renderPreview(noteContentTextarea.value);
            }
        });
    </script>
</body>
</html>